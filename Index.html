<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BookTins ‚Äî Complete Publishing Suite</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Libraries: Mammoth, jsPDF, html2canvas, JSZip, EPUB -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ebook-epub@1.0.2/dist/epub.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #2C3E50;
      --secondary: #E0E6ED;
      --accent: #C0392B;
      --text: #2C3E50;
      --text-light: #5A6B7C;
      --white: #FFFFFF;
      --radius: 8px;
      --shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      color: var(--text);
      line-height: 1.6;
    }

    header {
      background: var(--primary);
      color: var(--white);
      padding: 1.5rem 2rem;
      text-align: center;
      box-shadow: var(--shadow);
    }

    nav {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid #d0d6db;
      overflow-x: auto;
      scrollbar-width: none;
    }

    nav::-webkit-scrollbar { display: none; }

    nav button {
      flex: 1;
      min-width: 110px;
      padding: 1rem;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      transition: color 0.2s;
      position: relative;
    }

    nav button:hover { color: var(--primary); }
    nav button.active { color: var(--primary); }
    nav button.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40%;
      height: 3px;
      background: var(--accent);
      border-radius: 3px;
    }

    main {
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }

    label {
      display: block;
      margin: 1.25rem 0 0.5rem;
      font-weight: 600;
      font-size: 0.95rem;
    }

    textarea, input, select, button {
      width: 100%;
      padding: 0.85rem;
      border: 1px solid #cbd5e0;
      border-radius: var(--radius);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
    }

    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--white);
    }

    textarea { min-height: 200px; resize: vertical; }

    button.save-btn, button.ai-btn, .upload-btn, .export-btn {
      background: var(--accent);
      color: var(--white);
      border: none;
      padding: 0.85rem 1.75rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background 0.2s, transform 0.15s;
      width: auto;
      display: inline-block;
    }

    .export-btn { background: #27ae60; }
    .export-btn:hover { background: #219653; }

    button.ai-btn { background: var(--primary); }
    button.save-btn:hover { background: #a52a1e; transform: translateY(-2px); }
    button.ai-btn:hover { background: #1a252f; }

    .chapter-list {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .chapter-list li {
      padding: 0.85rem;
      border-radius: var(--radius);
      margin-bottom: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .chapter-list li:hover { background: var(--secondary); }

    .ai-instructions, .upload-zone {
      background: #f0f7ff;
      padding: 1.25rem;
      border-radius: var(--radius);
      margin: 1rem 0;
      border: 2px dashed #cbd5e0;
      text-align: center;
    }

    .upload-zone.drag-over {
      border-color: var(--primary);
      background: #e6f0fa;
    }

    .cover-canvas-container {
      background: white;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      margin: 1rem 0;
      text-align: center;
    }

    canvas#cover-canvas {
      max-width: 100%;
      border: 1px solid #eee;
    }

    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-light);
      font-size: 0.9rem;
      border-top: 1px solid #eaeef2;
      margin-top: 2rem;
    }

    #pdf-content { position: absolute; left: -9999px; top: -9999px; }
    
    /* Public Book Reader */
    .public-reader {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
      line-height: 1.8;
    }
    .public-reader header {
      background: var(--primary);
      color: white;
      padding: 2rem 1rem;
      text-align: center;
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <!-- App will be rendered here -->
  </div>

  <div id="pdf-content"></div>

  <script>
    // ======================
    // SUPABASE CONFIGURATION
    // ======================
    // üîë REPLACE THESE WITH YOUR SUPABASE PROJECT KEYS
    const SUPABASE_URL = 'https://inskajuwzolyyklkxkdx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imluc2thanV3em9seXlrbGt4a2R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc0MTcsImV4cCI6MjA3NDMwMzQxN30.s9KfTrFgEcU-Be9WWdo45FZ9uAy30j5I0wmI5RjnLVo';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ======================
    // BOOK DATA STRUCTURE
    // ======================
    let currentBook = {
      titles: [""],
      blurb: "",
      table_of_contents: [],
      chapter_summaries: [],
      cover_design_notes: "",
      cover_title: "",
      cover_author: ""
    };
    let currentChapterIndex = 0;
    let isSyncing = false;

    // ======================
    // INITIALIZATION
    // ======================
    async function init() {
      // Initialize anonymous session
      await initSupabaseSession();
      
      // Check if we're viewing a public book
      if (window.location.pathname.startsWith('/p/')) {
        const publishId = window.location.pathname.split('/p/')[1];
        loadPublicBook(publishId);
        return;
      }
      
      // Regular editor mode
      setupTabNavigation();
      setupFileUpload();
      await loadFromCloud();
      if (!currentBook.titles[0]) loadDefaultBook();
      renderApp();
    }

    async function initSupabaseSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const { error } = await supabase.auth.signInAnonymously();
        if (error) console.error('Anonymous auth error:', error);
      }
    }

    function loadDefaultBook() {
      currentBook = {
        titles: ["The BookTins Blueprint"],
        blurb: "Your guide to modern publishing.",
        table_of_contents: ["Introduction", "Chapter 1"],
        chapter_summaries: ["Welcome to BookTins...", "This is your first chapter."],
        cover_design_notes: "Clean, modern, empowering",
        cover_title: "The BookTins Blueprint",
        cover_author: "Author Name"
      };
    }

    // ======================
    // PUBLIC BOOK READER
    // ======================
    async function loadPublicBook(publishId) {
      try {
        const { data, error } = await supabase
          .from('published_books')
          .select('*')
          .eq('id', publishId)
          .single();

        if (error || !data) throw new Error('Book not found');

        document.body.innerHTML = `
          <header>
            <h1>${data.title}</h1>
            <p>${data.cover_author || 'Author'}</p>
          </header>
          <main class="public-reader">
            <p><em>${data.blurb}</em></p>
            ${data.table_of_contents.map((ch, i) => 
              `<h2>${ch}</h2><p>${data.chapter_summaries[i] || ''}</p>`
            ).join('')}
            <footer style="margin-top:3rem;text-align:center;color:#777;">
              Published on BookTins ‚Ä¢ <a href="/" style="color:#C0392B;">Create your own</a>
            </footer>
          </main>
        `;
      } catch (e) {
        document.body.innerHTML = `
          <div style="max-width:600px;margin:5rem auto;text-align:center;padding:1rem;">
            <h2>üìñ Book Not Found</h2>
            <p>The book you're looking for doesn't exist.</p>
            <a href="/" style="color:#C0392B;text-decoration:underline;">‚Üê Back to Editor</a>
          </div>
        `;
      }
    }

    // ======================
    // UI RENDERING
    // ======================
    function renderApp() {
      document.getElementById('app-container').innerHTML = `
        <header>
          <h1>üìò BookTins ‚Äî Complete Publishing Suite</h1>
          <p>Write, design, enhance, and publish anywhere</p>
        </header>

        <nav id="tabs">
          <button data-tab="dashboard" class="active">Dashboard</button>
          <button data-tab="editor">Editor</button>
          <button data-tab="design">Cover</button>
          <button data-tab="ai">AI</button>
          <button data-tab="export">Export</button>
        </nav>

        <main>
          <!-- Dashboard -->
          <section id="dashboard" class="tab-content active">
            <div class="card">
              <h2>üì§ Import Manuscript</h2>
              <div class="upload-zone" id="drop-zone">
                <p>Drag & drop <strong>.docx</strong> here<br>or</p>
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">Choose File</button>
                <input type="file" id="file-input" accept=".docx" style="display:none;" />
              </div>

              <h2>üìö Project</h2>
              <label for="book-title">Title</label>
              <input type="text" id="book-title" placeholder="Enter title" value="${currentBook.titles[0] || ''}">
              <label>Blurb</label>
              <textarea id="book-blurb" placeholder="Description...">${currentBook.blurb || ''}</textarea>
              <ul id="toc-list" class="chapter-list"></ul>
              <button class="save-btn" onclick="saveToCloud()">‚òÅÔ∏è Save to Cloud</button>
            </div>
          </section>

          <!-- Editor -->
          <section id="editor" class="tab-content">
            <div class="card">
              <h2>‚úçÔ∏è Edit Chapter</h2>
              <select id="chapter-select"></select>
              <textarea id="chapter-content" placeholder="Edit..."></textarea>
              <div class="ai-instructions">
                <strong>‚ú® AI Enhancement</strong>
              </div>
              <select id="ai-style">
                <option value="expand">Expand</option>
                <option value="refine">Refine</option>
                <option value="simplify">Simplify</option>
                <option value="dramatic">Dramatic</option>
              </select>
              <button class="ai-btn" onclick="enhanceWithAI()">‚ú® Enhance</button>
              <button class="save-btn" onclick="saveChapter()">üíæ Save</button>
            </div>
          </section>

          <!-- Cover Design -->
          <section id="design" class="tab-content">
            <div class="card">
              <h2>üé® Cover Generator</h2>
              <label>Cover Title</label>
              <input type="text" id="cover-title" placeholder="Book title for cover" value="${currentBook.cover_title || currentBook.titles[0] || ''}">
              <label>Author Name</label>
              <input type="text" id="cover-author" placeholder="Your name" value="${currentBook.cover_author || ''}">
              <label>Design Notes (for AI or reference)</label>
              <textarea id="cover-notes" placeholder="e.g., ocean, palm trees, sunset...">${currentBook.cover_design_notes || ''}</textarea>
              <button class="save-btn" onclick="generateCover()">üñºÔ∏è Generate Cover</button>
              <div class="cover-canvas-container">
                <canvas id="cover-canvas" width="1200" height="1800"></canvas>
                <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
                  6√ó9 inch (1200√ó1800 px) ‚Äî print-ready
                </p>
              </div>
              <button class="export-btn" onclick="downloadCover()">üì• Download Cover</button>
            </div>
          </section>

          <!-- AI -->
          <section id="ai" class="tab-content">
            <div class="card">
              <h2>ü§ñ AI Assistant</h2>
              <p>Enhance chapters using secure AI. Keys managed server-side.</p>
            </div>
          </section>

          <!-- Export -->
          <section id="export" class="tab-content">
            <div class="card">
              <h2>üì§ Export Your Book</h2>
              <label>Format</label>
              <select id="export-format">
                <option value="pdf">PDF (Print)</option>
                <option value="epub">EPUB (eBook)</option>
              </select>
              <label>ISBN (Optional)</label>
              <input type="text" id="isbn" placeholder="978-3-16-148410-0">
              <label>Keywords</label>
              <input type="text" id="keywords" placeholder="mystery, debut">
              <button class="export-btn" onclick="exportBook()">üöÄ Export</button>
              
              <label style="margin-top: 1.5rem;">Publish to Web</label>
              <button class="export-btn" onclick="publishToWeb()">üåê Publish Publicly</button>
              <p id="publish-url" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--primary);"></p>
            </div>
          </section>
        </main>

        <footer>
          BookTins ‚Äî Publish with confidence.
        </footer>
      `;
      
      syncUI();
      setupTabNavigation();
      setupFileUpload();
    }

    function syncUI() {
      // Update form fields
      if (document.getElementById('book-title')) {
        document.getElementById('book-title').value = currentBook.titles[0] || '';
        document.getElementById('book-blurb').value = currentBook.blurb || '';
        document.getElementById('cover-title').value = currentBook.cover_title || currentBook.titles[0] || '';
        document.getElementById('cover-author').value = currentBook.cover_author || '';
        document.getElementById('cover-notes').value = currentBook.cover_design_notes || '';
      }
      
      renderTOC();
      renderChapterSelector();
      if (currentBook.table_of_contents.length > 0) loadChapter(0);
      
      // Regenerate cover if canvas exists
      if (document.getElementById('cover-canvas')) {
        generateCoverPreview();
      }
    }

    // ======================
    // TAB NAVIGATION
    // ======================
    function setupTabNavigation() {
      document.querySelectorAll('[data-tab]').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('[data-tab]').forEach(btn => btn.classList.remove('active'));
          const tabId = button.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
          button.classList.add('active');
        });
      });
    }

    // ======================
    // DOCX UPLOAD
    // ======================
    function setupFileUpload() {
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      if (!dropZone || !fileInput) return;
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, preventDefaults, false);
      });
      
      function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
      
      ['dragenter', 'dragover'].forEach(e => 
        dropZone.addEventListener(e, () => dropZone.classList.add('drag-over'), false)
      );
      
      ['dragleave', 'drop'].forEach(e => 
        dropZone.addEventListener(e, () => dropZone.classList.remove('drag-over'), false)
      );
      
      dropZone.addEventListener('drop', (e) => handleFiles({ target: { files: e.dataTransfer.files } }), false);
      fileInput.addEventListener('change', handleFiles, false);
    }

    async function handleFiles(e) {
      const file = e.target.files[0];
      if (!file || !file.name.endsWith('.docx')) return alert('Please upload a .docx file.');
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.convertToHtml({ arrayBuffer });
        const parser = new DOMParser();
        const doc = parser.parseFromString(result.value, 'text/html');
        const headings = Array.from(doc.querySelectorAll('h1, h2, h3')).map(h => h.textContent);
        const paragraphs = Array.from(doc.querySelectorAll('p')).map(p => p.textContent.trim()).filter(p => p);
        
        currentBook = {
          titles: [headings[0] || file.name.replace('.docx', '')],
          blurb: paragraphs[0] || 'Imported from Word.',
          table_of_contents: headings.length ? headings : ['Chapter 1'],
          chapter_summaries: headings.map((_, i) => paragraphs.slice(i*3, (i+1)*3).join('\n\n') || 'No content.'),
          cover_design_notes: currentBook.cover_design_notes,
          cover_title: headings[0] || '',
          cover_author: currentBook.cover_author
        };
        
        syncUI();
        saveToCloud();
        alert('‚úÖ Document imported!');
      } catch (error) {
        console.error('Docx parsing error:', error);
        alert('‚ùå Failed to parse document. Ensure it\'s a valid .docx file.');
      }
    }

    // ======================
    // RENDERERS
    // ======================
    function renderTOC() {
      const list = document.getElementById('toc-list');
      if (!list) return;
      
      list.innerHTML = '';
      currentBook.table_of_contents.forEach((ch, i) => {
        const li = document.createElement('li');
        li.textContent = ch;
        li.onclick = () => { currentChapterIndex = i; loadChapter(i); };
        list.appendChild(li);
      });
    }

    function renderChapterSelector() {
      const sel = document.getElementById('chapter-select');
      if (!sel) return;
      
      sel.innerHTML = '';
      currentBook.table_of_contents.forEach((ch, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = ch;
        sel.appendChild(opt);
      });
      
      sel.onchange = (e) => { currentChapterIndex = +e.target.value; loadChapter(currentChapterIndex); };
    }

    function loadChapter(i) {
      currentChapterIndex = i;
      const contentEl = document.getElementById('chapter-content');
      if (contentEl) {
        contentEl.value = currentBook.chapter_summaries[i] || '';
      }
    }

    // ======================
    // SUPABASE CLOUD SAVE
    // ======================
    async function saveToCloud() {
      // Update currentBook from UI
      if (document.getElementById('book-title')) {
        currentBook.titles[0] = document.getElementById('book-title').value;
        currentBook.blurb = document.getElementById('book-blurb').value;
        currentBook.cover_title = document.getElementById('cover-title').value;
        currentBook.cover_author = document.getElementById('cover-author').value;
        currentBook.cover_design_notes = document.getElementById('cover-notes').value;
      }
      
      // Save to localStorage (fallback)
      localStorage.setItem('booktins_book', JSON.stringify(currentBook));
      
      // Save to Supabase
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert('‚úÖ Saved locally (cloud sync pending)');
        return;
      }
      
      try {
        const { error } = await supabase
          .from('books')
          .upsert({
            user_id: session.user.id,
            title: currentBook.titles[0],
            blurb: currentBook.blurb,
            table_of_contents: currentBook.table_of_contents,
            chapter_summaries: currentBook.chapter_summaries,
            cover_title: currentBook.cover_title,
            cover_author: currentBook.cover_author,
            cover_notes: currentBook.cover_design_notes
          }, {
            onConflict: 'user_id',
            returning: 'minimal'
          });

        if (error) throw error;
        alert('‚úÖ Saved to cloud (Supabase)');
      } catch (error) {
        console.error('Supabase save error:', error);
        alert('‚ö†Ô∏è Cloud save failed. Saved locally.');
      }
    }

    async function loadFromCloud() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        // Fallback to localStorage
        const saved = localStorage.getItem('booktins_book');
        if (saved) {
          try {
            currentBook = JSON.parse(saved);
          } catch (e) { /* ignore */ }
        }
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('books')
          .select('*')
          .eq('user_id', session.user.id)
          .single();
          
        if (error || !data) {
          // Fallback to localStorage
          const saved = localStorage.getItem('booktins_book');
          if (saved) {
            try {
              currentBook = JSON.parse(saved);
            } catch (e) { /* ignore */ }
          }
          return;
        }
        
        // Populate currentBook
        currentBook = {
          titles: [data.title],
          blurb: data.blurb,
          table_of_contents: data.table_of_contents || [],
          chapter_summaries: data.chapter_summaries || [],
          cover_title: data.cover_title,
          cover_author: data.cover_author,
          cover_design_notes: data.cover_notes
        };
      } catch (error) {
        console.error('Load from cloud error:', error);
        // Fallback to localStorage
        const saved = localStorage.getItem('booktins_book');
        if (saved) {
          try {
            currentBook = JSON.parse(saved);
          } catch (e) { /* ignore */ }
        }
      }
    }

    function saveChapter() {
      const contentEl = document.getElementById('chapter-content');
      if (contentEl) {
        currentBook.chapter_summaries[currentChapterIndex] = contentEl.value;
      }
      saveToCloud();
      alert('‚úÖ Chapter saved');
    }

    // ======================
    // AI ENHANCEMENT
    // ======================
    function enhanceWithAI() {
      const contentEl = document.getElementById('chapter-content');
      if (!contentEl || !contentEl.value.trim()) return alert('Enter content first.');
      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'üß† Processing...';
      
      setTimeout(() => {
        contentEl.value = `${contentEl.value}\n\n---\n‚ú® Enhanced by AI (simulated)`;
        btn.disabled = false;
        btn.textContent = '‚ú® Enhance';
        saveChapter();
      }, 1200);
    }

    // ======================
    // COVER GENERATOR
    // ======================
    function generateCoverPreview() {
      const canvas = document.getElementById('cover-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const title = currentBook.cover_title || currentBook.titles[0] || 'Untitled';
      const author = currentBook.cover_author || 'Author';
      
      // Background gradient (sky blue to sand)
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#87CEEB');
      gradient.addColorStop(1, '#F4A460');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Title
      ctx.fillStyle = '#2C3E50';
      ctx.font = 'bold 80px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(title, canvas.width / 2, canvas.height / 2 - 60);
      
      // Author
      ctx.font = '500 40px Inter';
      ctx.fillText(author, canvas.width / 2, canvas.height / 2 + 40);
    }

    function generateCover() {
      generateCoverPreview();
      currentBook.cover_title = document.getElementById('cover-title')?.value || currentBook.titles[0] || '';
      currentBook.cover_author = document.getElementById('cover-author')?.value || '';
      saveToCloud();
    }

    function downloadCover() {
      const canvas = document.getElementById('cover-canvas');
      if (!canvas) return;
      
      const link = document.createElement('a');
      link.download = `${currentBook.cover_title || 'cover'}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // ======================
    // PUBLISH TO WEB
    // ======================
    async function publishToWeb() {
      if (!currentBook.titles[0]) return alert('Add a title first.');
      
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return alert('Please wait for authentication...');
      
      try {
        // First, ensure the book is saved
        await saveToCloud();
        
        // Get the book ID
        const { data: bookData } = await supabase
          .from('books')
          .select('id')
          .eq('user_id', session.user.id)
          .single();
          
        if (!bookData) throw new Error('Book not found');
        
        // Publish
        const { data: published, error } = await supabase
          .from('published_books')
          .insert({
            book_id: bookData.id,
            title: currentBook.titles[0],
            blurb: currentBook.blurb,
            table_of_contents: currentBook.table_of_contents,
            chapter_summaries: currentBook.chapter_summaries,
            cover_author: currentBook.cover_author
          })
          .select('id')
          .single();
          
        if (error) throw error;
        
        const url = `${window.location.origin}/p/${published.id}`;
        document.getElementById('publish-url').textContent = url;
        alert('‚úÖ Published! Anyone with the link can read it.');
      } catch (error) {
        console.error('Publish error:', error);
        alert('‚ùå Failed to publish. Try again.');
      }
    }

    // ======================
    // EXPORT FUNCTIONS
    // ======================
    async function exportBook() {
      const formatEl = document.getElementById('export-format');
      const format = formatEl ? formatEl.value : 'pdf';
      
      if (format === 'pdf') {
        await exportPDF();
      } else if (format === 'epub') {
        await exportEPUB();
      }
    }

    async function exportPDF() {
      const title = currentBook.titles[0] || 'Book';
      let html = `<h1>${title}</h1><p><em>${currentBook.blurb}</em></p>`;
      html += `<div class="toc"><h2>Table of Contents</h2><ul>`;
      currentBook.table_of_contents.forEach(ch => html += `<li>${ch}</li>`);
      html += `</ul></div>`;
      currentBook.table_of_contents.forEach((ch, i) => {
        html += `<h2>${ch}</h2><p>${currentBook.chapter_summaries[i] || ''}</p>`;
      });

      const pdfContent = document.getElementById('pdf-content');
      pdfContent.innerHTML = html;
      
      try {
        const canvas = await html2canvas(pdfContent, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + pageHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        pdf.save(`${title.replace(/\s+/g, '_')}.pdf`);
      } catch (error) {
        console.error('PDF export error:', error);
        alert('‚ùå PDF export failed. Try again.');
      }
    }

    async function exportEPUB() {
      const title = currentBook.titles[0] || 'Book';
      const chapters = currentBook.table_of_contents.map((ch, i) => ({
        title: ch,
        content: `<p>${currentBook.chapter_summaries[i] || ''}</p>`
      }));

      try {
        const epub = new Epub({
          title: title,
          author: currentBook.cover_author || 'Unknown',
          cover: null
        });

        epub.addChapter({ title: 'Blurb', content: `<p>${currentBook.blurb}</p>` });
        chapters.forEach(ch => epub.addChapter(ch));

        const blob = await epub.generateAsync();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title.replace(/\s+/g, '_')}.epub`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('EPUB export error:', error);
        alert('‚ùå EPUB export failed. Try again.');
      }
    }

    // ======================
    // START APP
    // ======================
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>